<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Calculateur de prix des diagnostics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <h1>Calculateur de prix des diagnostics</h1>
  <p class="muted small">Les tarifs de base couvrent 0 à 100 m². Au-delà, choisissez la méthode d'ajustement souhaitée pour les diagnostics.</p>

  <div class="stack" id="flowRoot">
    <div class="card" id="stepArea">
      <h2>Étape 1 · Surface</h2>
      <div class="row" style="justify-content: space-between; gap:16px; flex-wrap:wrap;">
        <fieldset>
          <legend>Type de prestation</legend>
          <label><input type="radio" name="jobType" value="normal" checked /> Standard</label>
          <label style="margin-left:16px;"><input type="radio" name="jobType" value="parking" /> Parking uniquement</label>
          <label style="margin-left:16px;"><input type="radio" name="jobType" value="cave" /> Cave uniquement</label>
        </fieldset>
        <label>Surface (m²)
          <input type="number" id="area" min="1" step="1" value="60" />
        </label>
        <div class="row" style="align-items:center; gap:8px;">
          <span class="muted small">Pack suggéré</span>
          <span class="pill" id="derivedPack">F3</span>
        </div>
        <fieldset id="scalingMethodGroup" style="min-width:220px;">
          <legend>Ajustement &gt; 100 m²</legend>
          <label><input type="radio" name="scalingMethod" value="factor" checked /> Multiplicateur classique</label>
          <label><input type="radio" name="scalingMethod" value="philippe" /> Méthode Philippe</label>
          <p class="muted small" id="scalingMethodHint">Option disponible uniquement si la surface dépasse 100 m².</p>
        </fieldset>
        <button class="btn" id="nextToType">Suivant</button>
      </div>
    </div>

    <div class="card" id="stepType" style="display:none;">
      <h2>Étape 2 · Type de bien</h2>
      <div class="row" style="gap:16px; align-items:center;">
        <label><input type="radio" name="propType" value="apartment" checked /> Appartement</label>
        <label><input type="radio" name="propType" value="house" /> Maison / Pavillon</label>
        <label><input type="checkbox" id="opt_studette" /> Studette</label>
        <button class="btn" id="nextToPurpose">Suivant</button>
      </div>
        </div>

    <div class="card" id="stepPurpose" style="display:none;">
      <h2>Étape 3 · Objet</h2>
      <div class="row" style="gap:16px; align-items:center;">
        <label><input type="radio" name="purpose" value="rent" checked /> Location</label>
        <label><input type="radio" name="purpose" value="sale" /> Vente</label>
        <label><input type="checkbox" id="opt_agent" /> Mandataire (ERP offert)</label>
        <button class="btn" id="nextToDiags">Suivant</button>
      </div>
    </div>

    <div class="card" id="stepDiags" style="display:none;">
      <h2>Étape 4 · Diagnostics</h2>
      <p class="muted small">Cliquez pour sélectionner. TERMITES uniquement pour la vente.</p>
      <div id="diagnosticsList" class="row" style="flex-wrap:wrap; gap:8px;"></div>
    </div>

    <div class="card" id="resultCard" style="display:none;">
      <div class="row" style="justify-content: space-between; align-items: center;">
        <h2 style="margin:0;">Résultat</h2>
        <button id="calc" class="btn">Calculer</button>
      </div>
      <div id="result"></div>
    </div>
    <div class="card" id="stepInvoice" style="display:none;">
      <h2>Étape 5 · Facturation</h2>
      <div class="stack">
        <!-- duplicate name fields removed; keep the civility/name/company block below -->
        <fieldset>
          <legend>Civilité / Société</legend>
          <div class="row" style="gap:16px; align-items:center;">
            <label><input type="radio" name="inv_civ" value="M." checked /> M.</label>
            <label><input type="radio" name="inv_civ" value="Mme" /> Mme</label>
            <label><input type="radio" name="inv_civ" value="both" /> M. & Mme</label>
            <label><input type="radio" name="inv_civ" value="company" /> Société</label>
          </div>
        </fieldset>

        <!-- name / company inputs -->
        <div id="inv_name_row" class="row" style="gap:8px; margin-top:8px;">
          <label style="flex:1">Nom (obligatoire pour personne)
            <input type="text" id="inv_last" class="w-100" placeholder="ex: DUPONT" />
          </label>
          <label style="flex:1">Prénom (optionnel)
            <input type="text" id="inv_first" class="w-100" placeholder="ex: pierre" />
          </label>
        </div>
        <div id="inv_company_row" style="display:none; margin-top:8px;">
          <label class="w-100">Société
            <input type="text" id="inv_company" class="w-100" placeholder="Nom de la société" />
          </label>
        </div>
        <div class="row" style="align-items:flex-end;">
          <label class="flex-1 dropdown">Recherche d'adresse (auto-remplissage)
            <input type="text" id="inv_search" class="w-100" placeholder="ex : 10 rue de Rivoli, Paris" autocomplete="off" />
            <div id="addr_suggestions" class="dropdown-menu" style="display:none;"></div>
          </label>
          <span id="addr_status" class="small muted" style="margin-left:8px;"></span>
        </div>
        <label class="w-100">Numéro de voie
          <input type="text" id="inv_num" class="w-100" />
        </label>
        <label class="w-100">Nom de rue
          <input type="text" id="inv_street" class="w-100" />
        </label>
        <label class="w-100">Code postal
          <input type="text" id="inv_postal" class="w-100" />
        </label>
        <label class="w-100">Ville
          <input type="text" id="inv_city" class="w-100" />
        </label>
        <label class="w-100">Désignation des diagnostics (B21)
          <textarea id="inv_designation" class="w-100" rows="2">1 Pack Amiante, Loi Carrez, Plomb, DPE, Electricité, Gaz, Termite et ERP avec Nuisances Sonores Aériennes</textarea>
        </label>
        <label class="w-100">Description du bien (B25)
          <textarea id="inv_description" class="w-100" rows="2">Appartement F3/F4</textarea>
        </label>
        <label class="w-100">Type de bien (A21)
          <select id="inv_type_bien" class="w-100">
            <option value="APPARTEMENT">APPARTEMENT</option>
            <option value="MAISON">MAISON</option>
            <option value="CAVE">CAVE</option>
            <option value="STUDETTE">STUDETTE</option>
            <option value="PARKING">PARKING</option>
          </select>
        </label>
        <div class="row" style="justify-content: center; align-items:center; gap:12px;">
          <span id="inv_status" class="small muted"></span>
          <button id="continueInvoice" class="btn">Créer le devis</button>
        </div>
        <div class="row" id="postExportActions" style="justify-content:center; margin-top:16px; display:none;">
          <button id="newInvoice" class="btn secondary">Nouveau devis</button>
        </div>
      </div>
    </div>
  </div>
  <script defer src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script type="module" src="./assets/app.js"></script>
  
</body>
</html>
